- hosts: ec2
  become: yes
  gather_facts: false
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Ensure Python 3 is installed
      raw: |
        if ! command -v python3 >/dev/null 2>&1; then
          sudo yum install -y python3
        fi
      register: python_install
      changed_when: python_install.rc == 0
      ignore_errors: yes

    - name: Wait a moment before fact gathering (avoid SSH race condition)
      pause:
        seconds: 3

    - name: Re-enable fact gathering safely
      setup:
      retries: 3
      delay: 2
      register: setup_result
      until: setup_result is succeeded

    - name: Instalar pacotes básicos
      yum:
        name:
          - python3
          - python3-pip
        state: present

    - name: Instalar bibliotecas Python
      pip:
        name:
          - boto3
          - pandas

    - name: Criar diretórios de dados
      file:
        path: "/data/{{ item }}"
        state: directory
      loop:
        - raw
        - trusted
        - client

